#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <netdb.h>
#include <arpa/inet.h>
#include <time.h>

void kill_switch_activated() {
    puts("Malware deactivated, the flag is HackUTT{killswitch2-killswitch1}");
}

void print_random_char() {
    int random_num = rand() % 127;
    printf("%c", random_num);
}

void do_attack(){
    puts("Starting attack");
    srand(time(NULL));
    for(int i=0; i<10000; i++){
        print_random_char();
    }
    puts("");
    puts("TODO: attack function");
}

int check_killswitch1() {
    const char *filename = "/I/dont/know/this/folder";  // Change this to your file name
    const char *target_string = "IWANTTOSTOP";
    FILE *file = fopen(filename, "r");
    if (file == NULL)
        return 0;

    char line[256];  // Buffer to read each line from the file
    fgets(line, sizeof(line), file);
    if (strstr(line, target_string) != NULL) {
        fclose(file);
        return 1; // String found in the file
    }

    fclose(file);
    return 0; // String not found in the file
}

int check_killswitch2(){
    const char *hostname = "IAMSURETHAT.com";
    struct addrinfo hints, *res;
    int status;

    // Initialize the hints structure to zero
    memset(&hints, 0, sizeof(hints));
    hints.ai_family = AF_UNSPEC; // Allow both IPv4 and IPv6 addresses
    hints.ai_socktype = SOCK_STREAM;

    // Call getaddrinfo to resolve the domain name
    status = getaddrinfo(hostname, NULL, &hints, &res);
    
    if (status != 0) {
        // If getaddrinfo fails, the domain does not exist or cannot be resolved
        return 0; // DNS does not exist
    }

    // Clean up after the resolution process
    freeaddrinfo(res);

    // If we reach here, the DNS exists
    return 1; // DNS exists
}

int main() {
    

    if (check_killswitch1()) {
        if(check_killswitch2()){
            kill_switch_activated();
        }else{
            puts("Kill switch 1 activated");
            do_attack();
        }
    } else {
        do_attack();
    }

    return 0;
}
