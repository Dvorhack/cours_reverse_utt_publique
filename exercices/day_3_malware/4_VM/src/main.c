#include <stdio.h>
#include <stdbool.h>
#include "vm.h"

static int f[] = {
	//.def f(x): ARGS=1, LOCALS=1
	//  a = x;
	LOAD, 0,                // 0	<-- start of f
	STORE, 1,               // 2
	// return a+1
	LOAD, 1,                // 4
    ICONST, 2,             // 6
    IADD,                   // 8
	RET,                    // 9
    //.def g(x): ARGS=1, LOCALS=1
	//  a = x;
	LOAD, 0,                // 10	<-- start of f
	STORE, 1,               // 12
	// return a+1
	LOAD, 1,                // 14
    ICONST, 7,              // 16
    IMUL,                   // 18
	RET,                    // 19
    //.def main() { print f(10); }
	ICONST, 73,             // 20
    PRINTC,                 // 22
    ICONST, 78,             // 23
    PRINTC,                 // 24
    ICONST, 58,             // 25
    PRINTC,                 // 27
    ICONST, 32,             // 28
    PRINTC,                 // 30
    GETC,                   // 31
	CALL, 0, 1, 1,          // 32
    CALL, 10, 1, 1,         // 36
    ICONST, 13371337,           // 40
    IEQ,                    // 42
    BRT, 66, // banch gagne // 43
    // perdu
	ICONST, 112,           // 45
    PRINTC,                 // 47
    ICONST, 101,           // 48
    PRINTC,                 // 50
    ICONST, 114,           // 51
    PRINTC,                 // 53
    ICONST, 100,           // 54
    PRINTC,                 // 56
    ICONST, 117,           // 57
    PRINTC,                 // 59
    ICONST, 10,           // 60
    PRINTC,                 // 62
    BR, 84,                 // 63
    // gagne
    ICONST, 103,           // 66
    PRINTC,                 // 68
    ICONST, 97,           // 69
    PRINTC,                 // 71
    ICONST, 103,           // 72
    PRINTC,                 // 74
    ICONST, 110,           // 75
    PRINTC,                 // 77
    ICONST, 101,           // 78
    PRINTC,                 // 80
    ICONST, 10,           // 81
    PRINTC,                 // 83
    //fin                   // 84
};

int main(int argc, char *argv[]) {
    VM *vm;

	vm = vm_create(f, sizeof(f)/sizeof(int));
	vm_exec(vm, 20, false);
	vm_free(vm);

	return 0;
}